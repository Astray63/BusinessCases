<div class="reservation-page">
  <div class="page-header">
    <h1>Gestion des R√©servations</h1>
    <p class="subtitle">R√©servez une borne √©lectrique ou g√©rez vos r√©servations existantes</p>
  </div>

  <!-- Navigation par onglets -->
  <div class="tabs-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'nouvelle'"
      (click)="changerTab('nouvelle')">
      <i class="icon-plus"></i> Nouvelle r√©servation
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'en-cours'"
      (click)="changerTab('en-cours')">
      <i class="icon-clock"></i> En cours ({{ reservationsEnCours.length }})
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'passees'"
      (click)="changerTab('passees')">
      <i class="icon-history"></i> Pass√©es ({{ reservationsPassees.length }})
    </button>
    <button 
      *ngIf="isProprietaire"
      class="tab-button" 
      [class.active]="activeTab === 'proprietaire'"
      (click)="changerTab('proprietaire')">
      <i class="icon-user"></i> Mes bornes ({{ reservationsProprietaire.length }})
    </button>
  </div>

  <!-- Contenu des onglets -->
  <div class="tab-content">
    
    <!-- ONGLET: Nouvelle r√©servation -->
    <div *ngIf="activeTab === 'nouvelle'" class="tab-panel">
      <div class="reservation-form-container">
        <h2>Effectuer une r√©servation</h2>
        
        <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()" class="reservation-form">
          
          <!-- S√©lection de la borne -->
          <div class="form-group">
            <label for="borneId">Borne de recharge *</label>
            <select 
              id="borneId" 
              formControlName="borneId" 
              class="form-control"
              (change)="selectionnerBorne($event)">
              <option value="">-- S√©lectionnez une borne disponible --</option>
              <option *ngFor="let borne of bornesDisponibles" [value]="borne.idBorne">
                {{ borne.localisation }} - {{ borne.type }} ({{ borne.puissance }} kW) - {{ borne.prix }}‚Ç¨/h
              </option>
            </select>
            <small class="form-text">Seules les bornes disponibles sont affich√©es</small>
          </div>

          <!-- Informations de la borne s√©lectionn√©e -->
          <div *ngIf="selectedBorne" class="borne-details">
            <h4>D√©tails de la borne</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="label">Localisation:</span>
                <span class="value">{{ selectedBorne.localisation }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Type:</span>
                <span class="value">{{ selectedBorne.type }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Puissance:</span>
                <span class="value">{{ selectedBorne.puissance }} kW</span>
              </div>
              <div class="detail-item">
                <span class="label">Prix:</span>
                <span class="value">{{ selectedBorne.prix }}‚Ç¨/heure</span>
              </div>
            </div>
          </div>

          <!-- Plage horaire -->
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="dateDebut">Date de d√©but *</label>
              <input 
                type="date" 
                id="dateDebut" 
                formControlName="dateDebut" 
                class="form-control"
                [min]="getCurrentDate()">
            </div>
            <div class="form-group col-md-6">
              <label for="heureDebut">Heure de d√©but *</label>
              <input 
                type="time" 
                id="heureDebut" 
                formControlName="heureDebut" 
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="dateFin">Date de fin *</label>
              <input 
                type="date" 
                id="dateFin" 
                formControlName="dateFin" 
                class="form-control"
                [min]="getCurrentDate()">
            </div>
            <div class="form-group col-md-6">
              <label for="heureFin">Heure de fin *</label>
              <input 
                type="time" 
                id="heureFin" 
                formControlName="heureFin" 
                class="form-control">
            </div>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="isLoading || reservationForm.invalid">
              <span *ngIf="!isLoading">üìÖ R√©server</span>
              <span *ngIf="isLoading">‚è≥ En cours...</span>
            </button>
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="reservationForm.reset()"
              [disabled]="isLoading">
              R√©initialiser
            </button>
          </div>

          <div class="info-message">
            <p>‚ÑπÔ∏è Une notification sera automatiquement envoy√©e au propri√©taire de la borne apr√®s votre r√©servation.</p>
          </div>
        </form>
      </div>
    </div>

    <!-- ONGLET: R√©servations en cours -->
    <div *ngIf="activeTab === 'en-cours'" class="tab-panel">
      <h2>R√©servations en cours</h2>
      <p class="description">R√©servations en attente de validation ou confirm√©es</p>

      <div *ngIf="reservationsEnCours.length === 0" class="empty-state">
        <p>Aucune r√©servation en cours</p>
      </div>

      <div class="reservations-grid">
        <div 
          *ngFor="let reservation of reservationsEnCours" 
          class="reservation-card"
          [class.en-attente]="reservation.statut === 'EN_ATTENTE'">
          
          <div class="reservation-header">
            <span class="reservation-id">#{{ reservation.idReservation }}</span>
            <span class="reservation-statut" [ngClass]="getStatutClass(reservation.statut)">
              {{ getStatutLabel(reservation.statut) }}
            </span>
          </div>

          <div class="reservation-body">
            <div class="info-row">
              <span class="icon">üìç</span>
              <div class="info-content">
                <strong>{{ reservation.borne.localisation }}</strong>
                <small>{{ reservation.borne.type }} - {{ reservation.borne.puissance }} kW</small>
              </div>
            </div>

            <div class="info-row">
              <span class="icon">üìÖ</span>
              <div class="info-content">
                <strong>{{ reservation.dateDebut | date:'dd/MM/yyyy' }}</strong>
                <small>{{ reservation.dateDebut | date:'HH:mm' }} - {{ reservation.dateFin | date:'HH:mm' }}</small>
              </div>
            </div>

            <div class="info-row">
              <span class="icon">‚è±Ô∏è</span>
              <div class="info-content">
                <strong>Dur√©e</strong>
                <small>{{ calculerDuree(reservation.dateDebut, reservation.dateFin) }}</small>
              </div>
            </div>

            <div class="info-row" *ngIf="reservation.montantTotal">
              <span class="icon">üí∞</span>
              <div class="info-content">
                <strong>Montant</strong>
                <small>{{ reservation.montantTotal }} ‚Ç¨</small>
              </div>
            </div>
          </div>

          <div class="reservation-footer">
            <button 
              class="btn btn-danger btn-sm" 
              (click)="cancelReservation(reservation.idReservation)"
              [disabled]="isLoading">
              Annuler
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ONGLET: R√©servations pass√©es -->
    <div *ngIf="activeTab === 'passees'" class="tab-panel">
      <div class="panel-header">
        <h2>R√©servations pass√©es</h2>
        
        <!-- Filtres -->
        <div class="filtres-container">
          <form [formGroup]="filtreForm" class="filtres-form">
            <div class="filtre-group">
              <label>Statut</label>
              <select formControlName="statut" class="form-control">
                <option value="">Tous</option>
                <option value="TERMINEE">Termin√©e</option>
                <option value="ANNULEE">Annul√©e</option>
                <option value="REFUSEE">Refus√©e</option>
              </select>
            </div>

            <div class="filtre-group">
              <label>Date d√©but</label>
              <input type="date" formControlName="dateDebut" class="form-control">
            </div>

            <div class="filtre-group">
              <label>Date fin</label>
              <input type="date" formControlName="dateFin" class="form-control">
            </div>

            <div class="filtre-group">
              <label>Borne</label>
              <select formControlName="borneId" class="form-control">
                <option value="">Toutes</option>
                <option *ngFor="let borne of bornes" [value]="borne.idBorne">
                  {{ borne.localisation }}
                </option>
              </select>
            </div>

            <div class="filtre-actions">
              <button 
                type="button" 
                class="btn btn-primary btn-sm" 
                (click)="appliquerFiltre()">
                Filtrer
              </button>
              <button 
                type="button" 
                class="btn btn-secondary btn-sm" 
                (click)="reinitialiserFiltre()"
                *ngIf="filtreActif">
                R√©initialiser
              </button>
            </div>
          </form>
        </div>

        <!-- Actions d'export -->
        <div class="export-actions">
          <button 
            class="btn btn-success" 
            (click)="exporterExcel()"
            [disabled]="reservationsPassees.length === 0 || isLoading">
            üìä Exporter Excel
          </button>
        </div>
      </div>

      <div *ngIf="reservationsPassees.length === 0" class="empty-state">
        <p>Aucune r√©servation pass√©e</p>
      </div>

      <div class="reservations-table" *ngIf="reservationsPassees.length > 0">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Borne</th>
              <th>Date</th>
              <th>Dur√©e</th>
              <th>Statut</th>
              <th>Montant</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reservation of reservationsPassees">
              <td>#{{ reservation.idReservation }}</td>
              <td>
                <strong>{{ reservation.borne.localisation }}</strong><br>
                <small>{{ reservation.borne.type }}</small>
              </td>
              <td>
                {{ reservation.dateDebut | date:'dd/MM/yyyy' }}<br>
                <small>{{ reservation.dateDebut | date:'HH:mm' }} - {{ reservation.dateFin | date:'HH:mm' }}</small>
              </td>
              <td>{{ calculerDuree(reservation.dateDebut, reservation.dateFin) }}</td>
              <td>
                <span class="badge" [ngClass]="getStatutClass(reservation.statut)">
                  {{ getStatutLabel(reservation.statut) }}
                </span>
                <div *ngIf="reservation.motifRefus" class="motif-refus">
                  <small>{{ reservation.motifRefus }}</small>
                </div>
              </td>
              <td>
                <strong *ngIf="reservation.montantTotal">{{ reservation.montantTotal }} ‚Ç¨</strong>
                <span *ngIf="!reservation.montantTotal">-</span>
              </td>
              <td>
                <button 
                  *ngIf="reservation.statut === 'TERMINEE' || reservation.statut === 'CONFIRMEE'"
                  class="btn btn-sm btn-outline" 
                  (click)="genererRecuPDF(reservation)"
                  [disabled]="isLoading">
                  üìÑ Re√ßu PDF
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ONGLET: Gestion propri√©taire -->
    <div *ngIf="activeTab === 'proprietaire' && isProprietaire" class="tab-panel">
      <h2>R√©servations de mes bornes</h2>
      <p class="description">G√©rez les demandes de r√©servation pour vos bornes</p>

      <div *ngIf="reservationsProprietaire.length === 0" class="empty-state">
        <p>Aucune r√©servation pour vos bornes</p>
      </div>

      <div class="reservations-grid">
        <div 
          *ngFor="let reservation of reservationsProprietaire" 
          class="reservation-card proprietaire-card">
          
          <div class="reservation-header">
            <span class="reservation-id">#{{ reservation.idReservation }}</span>
            <span class="reservation-statut" [ngClass]="getStatutClass(reservation.statut)">
              {{ getStatutLabel(reservation.statut) }}
            </span>
          </div>

          <div class="reservation-body">
            <div class="info-row">
              <span class="icon">üë§</span>
              <div class="info-content">
                <strong>{{ reservation.utilisateur.prenom }} {{ reservation.utilisateur.nom }}</strong>
                <small>{{ reservation.utilisateur.email }}</small>
              </div>
            </div>

            <div class="info-row">
              <span class="icon">üìç</span>
              <div class="info-content">
                <strong>{{ reservation.borne.localisation }}</strong>
                <small>{{ reservation.borne.type }} - {{ reservation.borne.puissance }} kW</small>
              </div>
            </div>

            <div class="info-row">
              <span class="icon">üìÖ</span>
              <div class="info-content">
                <strong>{{ reservation.dateDebut | date:'dd/MM/yyyy' }}</strong>
                <small>{{ reservation.dateDebut | date:'HH:mm' }} - {{ reservation.dateFin | date:'HH:mm' }}</small>
              </div>
            </div>

            <div class="info-row">
              <span class="icon">‚è±Ô∏è</span>
              <div class="info-content">
                <strong>Dur√©e</strong>
                <small>{{ calculerDuree(reservation.dateDebut, reservation.dateFin) }}</small>
              </div>
            </div>

            <div class="info-row" *ngIf="reservation.montantTotal">
              <span class="icon">üí∞</span>
              <div class="info-content">
                <strong>Revenu estim√©</strong>
                <small>{{ reservation.montantTotal }} ‚Ç¨</small>
              </div>
            </div>
          </div>

          <div class="reservation-footer" *ngIf="reservation.statut === 'EN_ATTENTE'">
            <button 
              class="btn btn-success btn-sm" 
              (click)="accepterReservation(reservation.idReservation)"
              [disabled]="isLoading">
              ‚úì Accepter
            </button>
            <button 
              class="btn btn-danger btn-sm" 
              (click)="refuserReservation(reservation.idReservation)"
              [disabled]="isLoading">
              ‚úó Refuser
            </button>
          </div>

          <div class="reservation-footer" *ngIf="reservation.statut !== 'EN_ATTENTE'">
            <span class="status-text">
              {{ getStatutLabel(reservation.statut) }}
            </span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Loader global -->
  <div *ngIf="isLoading" class="global-loader">
    <div class="spinner"></div>
  </div>
</div>
